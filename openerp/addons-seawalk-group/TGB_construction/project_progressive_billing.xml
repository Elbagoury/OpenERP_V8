<?xml version="1.0"?>
<openerp>
    <data>

        <record id="tgb_progressive_billing_tree" model="ir.ui.view">
            <field name="name">tgb.progressive.billing.tree</field>
            <field name="model">progressive.billing</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="number"/>
                    <field name="sale_order_id"/>
                    <field name="customer_id" string="Customer"/>
                    <field name="date_invoice"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <record id="tgb_progressive_billing_form" model="ir.ui.view">
            <field name="name">tgb.progressive.billing.form</field>
            <field name="model">progressive.billing</field>
            <field name="arch" type="xml">
                <form string="Project Billing">
                    <header>
                        <button name="action_approve_billing" type="object" string="Approve Billing"
                                attrs="{'invisible':['|',('state', '!=', 'draft')]}"
                                groups="base.group_user" class="oe_highlight"/>
                        <button name="action_create_invoice" type="object" string="Create Invoices"
                                attrs="{'invisible':['|',('state', '!=', 'open')]}"
                                groups="base.group_user" class="oe_highlight"/>

                        <button name="action_view_invoice" type="object" string="View Invoices"
                                attrs="{'invisible':['|',('state', '!=', 'invoiced')]}"
                                groups="base.group_user" class="oe_highlight"/>

                        <button name="invoice_print" string="Print Invoice" type="object"
                                groups="base.group_user" invisible="1"/>
                        <button name="invoice_cancel" states="draft,proforma2,open" string="Cancel Invoice"
                                groups="base.group_no_one"/>
                        <button name="action_cancel_draft" states="cancel" string="Reset to Draft" type="object"
                                groups="base.group_user"/>
                        <field name="state" widget="statusbar" nolabel="1" statusbar_visible="draft,open,paid"/>
                    </header>
                    <sheet string="Project Billing">
                        <h1>
                            <label string="Draft Billing"
                                   attrs="{'invisible': ['|',('state','not in',('draft',))]}"/>
                            <field name="number" readonly="1" class="oe_inline"/>
                        </h1>
                        <group>
                            <group>
                                <field name="sale_order_id"/>
                                <field string="Customer" name="customer_id"
                                       context="{'search_default_customer':1, 'show_address': 1}"
                                       options='{"always_reload": True}'
                                       domain="[('customer', '=', True)]"/>
                            </group>
                            <group>
                                <field name="date_invoice"/>
                                <label for="currency_id" groups="base.group_multi_currency"/>
                                <div groups="base.group_multi_currency">
                                    <field name="currency_id" class="oe_inline"/>
                                    <button name="%(account.action_account_change_currency)d" type="action"
                                            class="oe_inline oe_link oe_edit_only"
                                            string="(change)"
                                            attrs="{'invisible':[('state','!=','draft')]}"
                                            groups="account.group_account_user"/>
                                </div>
                                <field name="retention_required" invisible="1"/>
                            </group>
                        </group>
                        <field name="is_deposit_billing" invisible="1"/>
                        <notebook colspan="4">
                            <page string="Project Details" attrs="{'invisible':[('is_deposit_billing','=',True)]}">
                                <field name="line_ids" nolabel="1" widget="one2many_list">
                                    <tree string="Billing Details" editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="description"/>
                                        <field name="contract_sum" sum="Total contract_sum"/>
                                        <field name="total_work_up_to_date"/>
                                        <field name="total_work_to_date" sum="Total total_work_to_date"/>
                                        <field name="total_work_previous_date" sum="Total total_work_previous_date"/>
                                        <field name="this_valuation" sum="Total this_valuation"/>
                                    </tree>
                                </field>
                                <group colspan="2" col="2">
                                    <field name="retention_amount" invisible="1"/>
                                    <field name="amount_claim_todate"/>
                                    <field name="less_rentention" attrs="{'invisible':[('retention_amount','=',0)]}"/>
                                    <field name="less_payment_claimed"/>
                                    <field name="amount_for_this_claim"/>
                                </group>
                            </page>

                            <page string="Deposit" attrs="{'invisible':[('is_deposit_billing','=',False)]}">
                                <group>
                                    <field name="deposit_amount"/>
                                </group>
                            </page>

                            <page string="Retention Project" attrs="{'invisible':[('retention_required','=',False)]}">
                                <group colspan="8" col="4">
                                    <field name="retention_type" colspan="1"/>
                                    <field name="retention_amount" attrs="{'invisible':[('retention_type','=','P')]}" colspan="1"/>
                                    <field name="retention_percent" attrs="{'invisible':[('retention_type','=','A')]}" colspan="1"/>
                                    <newline/>
                                    <field name="retention_day" />
                                </group>
                            </page>

                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>


        <record id="tgb_construction_project_progressive_billing_action" model="ir.actions.act_window">
            <field name="name">Project Progressive Billing</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">progressive.billing</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{}</field>
        </record>


        <menuitem name="Project Progressive Billing"
                  id="project_progressive_billing_menu" parent="menu_construction_project_billing_menu"
                  action="tgb_construction_project_progressive_billing_action"/>

    </data>
</openerp>
